<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>æé€Ÿè“å…‰å½±è§† - AI Edition</title>
    <!-- æ ¸å¿ƒåº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <!-- DPlayer -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    
    <!-- â˜…â˜…â˜… æ ¸å¿ƒè³‡ç”¢ï¼šFirebase å…¼å®¹ç‰ˆ SDK â˜…â˜…â˜… -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        function detectDevice() {
            const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isWideScreen = window.innerWidth > 768;
            if (isWideScreen || !isMobileUA) {
                document.documentElement.classList.add('is-desktop');
            } else {
                document.documentElement.classList.remove('is-desktop');
            }
        }
        detectDevice();
        window.addEventListener('resize', detectDevice);
    </script>

    <style>
        :root { --main-red: #e50914; --bg-deep: #06090f; }
        body { background-color: var(--bg-deep); color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        html.is-desktop body { background-image: url('https://images.unsplash.com/photo-1616530940355-351fabd9524b?q=80&w=2835&auto=format&fit=crop'); background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; min-height: 100vh; backdrop-filter: blur(20px); overflow: hidden; }
        html.is-desktop #app-wrapper { width: 100%; max-width: 450px; height: 90vh; max-height: 850px; background-color: var(--bg-deep); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; position: relative; overflow-y: auto; overflow-x: hidden; }
        html.is-desktop #app-wrapper::-webkit-scrollbar { width: 0px; background: transparent; }
        #app-wrapper { width: 100%; min-height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .mobile-header { height: 60px; }
        html.is-desktop .fixed-w-limit { position: absolute; width: 100%; left: 0; border-radius: 24px 24px 0 0; }
        html.is-desktop .bottom-nav.fixed-w-limit { border-radius: 0 0 24px 24px; bottom: 0; }
        html.is-desktop #passwordView, html.is-desktop #searchOverlay, html.is-desktop #liveRoom { border-radius: 24px; }
        
        .pill { padding: 0.4rem 1rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; transition: all 0.3s; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; white-space: nowrap;}
        .pill.active { background: var(--main-red); border-color: var(--main-red); color: white; box-shadow: 0 4px 12px rgba(229, 9, 20, 0.3); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; display: flex; justify-content: space-around; items: center; z-index: 2000; border-top: 1px solid rgba(255,255,255,0.05); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #64748b; font-size: 10px; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--main-red); }
        .loader { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--main-red); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* å´é‚Šæ¬„ EPG */
        .epg-sidebar { position: absolute; top: 0; left: 0; bottom: 0; width: 240px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 3001; transform: translateX(-100%); transition: transform 0.3s ease; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .epg-sidebar.open { transform: translateX(0); }
        .epg-item { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-size: 12px; color: #94a3b8; display: flex; justify-content: space-between; }
        .epg-item.active { color: #e50914; background: rgba(229,9,20,0.1); font-weight: bold; }
        
        /* æ‰‹å‹¢æç¤º */
        .swipe-hint { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); color: rgba(255,255,255,0.3); font-size: 40px; pointer-events: none; animation: floatY 2s infinite; }
        @keyframes floatY { 0%, 100% { transform: translate(0, -50%); opacity: 0.1; } 50% { transform: translate(0, -60%); opacity: 0.4; } }

        /* ç›´æ’­å¡ç‰‡æ¨£å¼ */
        .live-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.05); }
        .live-badge { background: linear-gradient(to right, #f87171, #ef4444); box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .live-badge-adult { background: linear-gradient(to right, #db2777, #ec4899); box-shadow: 0 0 10px rgba(236, 72, 153, 0.5); }

        /* è¯„è®ºåŒºåŠ¨ç”» */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .comment-scroll { mask-image: linear-gradient(transparent, black 10%, black 90%, transparent); -webkit-mask-image: linear-gradient(transparent, black 10%, black 90%, transparent); }
        .vip-diamond { background: linear-gradient(135deg, #e0f2fe 0%, #38bdf8 50%, #0284c7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
        .svip-gold { background: linear-gradient(135deg, #fef08a 0%, #eab308 50%, #a16207 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
        
        /* æ–°å¢ï¼šé¢„è§ˆå›¾é—ªçƒæ›´æ–°åŠ¨ç”» */
        .preview-refresh { animation: flash 0.5s; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; filter: brightness(1.5); } 100% { opacity: 1; } }
        
        /* æ’­æ”¾å™¨åŠ è½½å±‚ */
        .player-loader { position: absolute; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 50; }

        /* AI æŒ‰é’®åŠ¨ç”» */
        .ai-sparkle { background: linear-gradient(45deg, #8b5cf6, #d946ef); animation: sparkle 2s infinite; }
        @keyframes sparkle { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <!-- PCç«¯é«˜çº§å¹¿å‘Š -->
    <div class="hidden md:block fixed left-10 top-1/2 -translate-y-1/2 text-white z-0">
        <h1 class="text-6xl font-black mb-4 tracking-tighter">IPTV<span class="text-red-600">.</span></h1>
        <p class="text-gray-400 mb-8 text-lg">Global Live Streaming Network<br>é€‚é… PC æ™ºèƒ½æ¨¡æ‹Ÿå™¨</p>
    </div>

    <div id="app-wrapper">
        <!-- ç™»å½•é¡µ -->
        <div id="passwordView" class="fixed inset-0 z-[9999] flex items-center justify-center p-6 bg-slate-950 fixed-w-limit">
            <div class="relative w-full max-w-sm bg-slate-900/80 backdrop-blur-xl border border-white/10 p-10 rounded-[2.5rem] shadow-2xl text-center">
                <div class="w-20 h-20 bg-red-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-red-600/20"><i class="fas fa-bolt text-3xl text-white"></i></div>
                <h1 class="text-2xl font-black mb-2 text-white">ç§äººå½±é™¢</h1>
                <p class="text-gray-500 text-[10px] tracking-widest uppercase mb-8">Secure Access</p>
                <input id="accountInput" type="text" placeholder="è´¦å·" class="w-full bg-white/5 border border-white/10 rounded-xl py-4 px-4 text-center text-white mb-3">
                <input id="passwordInput" type="password" placeholder="å¯†ç " class="w-full bg-white/5 border border-white/10 rounded-xl py-4 px-4 text-center text-white mb-6">
                <button onclick="handleLogin()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-xl transition-all">
                    <span id="loginBtnText">ç™»å½• / è‡ªåŠ¨æ³¨å†Œ</span>
                    <div id="loginLoading" class="loader ml-2 hidden inline-block align-middle" style="width:16px;height:16px;"></div>
                </button>
            </div>
        </div>

        <div id="mainApp" class="hidden opacity-0 transition-opacity duration-700">
            <header class="fixed top-0 w-full z-[1000] glass mobile-header px-6 flex items-center justify-between fixed-w-limit transition-transform duration-300">
                <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                    <div class="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-play text-white text-[10px]"></i></div>
                    <span id="appTitle" class="text-lg font-black tracking-tighter text-white uppercase">CINEMA</span>
                </div>
                <button onclick="toggleSearch()" class="w-10 h-10 flex text-gray-400"><i class="fas fa-search"></i></button>
            </header>

            <main id="viewContainer" class="pt-16 pb-20 min-h-screen">
                <!-- é¦–é¡µ -->
                <div id="homeView">
                    <section class="mb-6 px-4">
                        <div class="swiper mainSwiper rounded-2xl overflow-hidden shadow-lg shadow-black/50">
                            <div class="swiper-wrapper" id="heroWrapper"></div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </section>
                    <section class="sticky top-[60px] z-[900] glass border-b border-white/5 py-3 -mx-4 px-4 mb-4 fixed-w-limit">
                        <div class="flex flex-col gap-3">
                            <div id="sourceFilters" class="flex gap-2 overflow-x-auto hide-scroll"></div>
                            <div id="cateFilters" class="flex gap-2 overflow-x-auto hide-scroll min-h-[30px] items-center"><span class="text-[10px] text-gray-500 animate-pulse">æ­£åœ¨åŒæ­¥...</span></div>
                        </div>
                    </section>
                    <section class="px-4">
                        <div id="movieGrid" class="grid grid-cols-2 gap-4"></div>
                        <div class="mt-8 flex justify-center gap-4">
                            <button onclick="fetchData(state.page - 1)" class="page-btn text-white">ä¸Šä¸€é¡µ</button>
                            <button onclick="fetchData(state.page + 1)" class="page-btn text-white">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </section>
                </div>

                <!-- ç›´æ’­å¤§å… -->
                <div id="liveView" class="hidden px-4">
                    <div class="mb-6">
                        <h2 class="text-2xl font-black text-white flex items-center gap-3">
                            <i class="fas fa-satellite-dish text-red-500"></i> å…¨çƒç›´æ’­
                        </h2>
                        <p class="text-xs text-gray-500 mt-1 pl-9">Global IPTV Network â€¢ 24H</p>
                    </div>
                    
                    <div id="adultLiveSection" class="hidden mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-pink-500 flex items-center gap-2"><i class="fas fa-fire"></i> å®æ—¶ç›‘æ§ <span class="text-[10px] bg-pink-500/20 px-2 py-0.5 rounded text-pink-300">VIP</span></h3>
                            <div class="flex items-center gap-1 text-[10px] text-green-400">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                å®æ—¶ç”»é¢åŒæ­¥ä¸­
                            </div>
                        </div>
                        <!-- ä¿®æ”¹ä¸ºåŒåˆ—ç½‘æ ¼ -->
                        <div id="adultLiveGrid" class="grid grid-cols-2 gap-3"></div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-blue-400 mb-3 flex items-center gap-2"><i class="fas fa-globe-asia"></i> å…¨çƒå«è§† <span class="text-[10px] bg-blue-500/20 px-2 py-0.5 rounded text-blue-300">Public</span></h3>
                        <div id="globalLiveGrid" class="grid grid-cols-1 gap-3"></div>
                    </div>
                </div>

                <!-- æ²‰æµ¸å¼ç›´æ’­é—´ -->
                <div id="liveRoom" class="hidden fixed inset-0 z-[3000] bg-black">
                    <div id="epgSidebar" class="epg-sidebar">
                        <div class="p-4 border-b border-white/10 flex justify-between items-center">
                            <h3 class="font-bold text-white">é¢‘é“åˆ—è¡¨</h3>
                            <span class="text-[10px] text-gray-400">ä¸Šä¸‹æ»‘åŠ¨åˆ‡æ¢</span>
                        </div>
                        <div id="epgList" class="flex-1 overflow-y-auto hide-scroll pb-20"></div>
                    </div>

                    <div id="liveTouchArea" class="w-full h-full relative">
                        <div id="livePlayerContainer" class="w-full h-full bg-black"></div>
                        <div id="liveLoadingIndicator" class="player-loader hidden"><div class="loader"></div></div>
                        
                        <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/80 to-transparent z-20 flex justify-between pointer-events-none">
                            <button onclick="toggleEpg()" class="pointer-events-auto bg-white/20 px-3 py-1 rounded-full text-xs text-white backdrop-blur"><i class="fas fa-list"></i> é€‰å°</button>
                            <button onclick="exitLiveRoom()" class="pointer-events-auto bg-black/40 w-8 h-8 rounded-full text-white backdrop-blur"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 to-transparent z-20 pointer-events-none">
                            <h2 id="liveChannelName" class="text-xl font-bold text-white shadow-black drop-shadow-md">Loading...</h2>
                            <div class="flex gap-2 mt-2 pointer-events-auto">
                                <button onclick="changeLiveLine(0)" class="bg-red-600 text-[10px] text-white px-3 py-1 rounded">ğŸš€ åŠ é€Ÿ</button>
                                <button onclick="changeLiveLine(1)" class="bg-white/20 text-[10px] text-white px-3 py-1 rounded">ğŸ”„ å¤‡ç”¨</button>
                            </div>
                        </div>

                        <div class="swipe-hint"><i class="fas fa-chevron-up"></i></div>
                    </div>
                </div>

                <div id="rankView" class="hidden px-4"></div>
                
                <!-- æˆ‘çš„é¡µé¢ -->
                <div id="profileView" class="hidden px-4 pt-4 pb-10">
                    <div class="flex items-center gap-4 mb-8 relative z-10">
                        <div class="relative w-16 h-16 cursor-pointer group" onclick="updateNickname()">
                            <div class="w-16 h-16 bg-gradient-to-tr from-red-600 to-orange-500 rounded-full flex items-center justify-center shadow-lg shadow-red-600/30 overflow-hidden">
                                <i class="fas fa-user-astronaut text-3xl text-white"></i>
                            </div>
                            <div class="absolute bottom-0 right-0 bg-white text-black rounded-full w-5 h-5 flex items-center justify-center text-[10px] border border-gray-900 group-hover:scale-110 transition-transform">
                                <i class="fas fa-pen"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 cursor-pointer" onclick="updateNickname()">
                                <h2 id="userNameDisplay" class="text-2xl font-black text-white hover:text-red-500 transition-colors">æˆ‘çš„æ”¶è—</h2>
                                <i class="fas fa-edit text-gray-500 text-xs"></i>
                            </div>
                            <p id="cloudStatus" class="text-xs text-gray-400 mt-1">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...</p>
                            <p id="userIdDisplay" class="text-[10px] text-gray-600 font-mono mt-0.5">Account: --</p>
                            <button onclick="handleLogout()" class="mt-2 text-[10px] bg-white/10 px-3 py-1.5 rounded-lg text-gray-300 hover:text-white hover:bg-red-600/50 transition-colors border border-white/5 cursor-pointer z-50 relative">é€€å‡ºç™»å½•</button>
                        </div>
                    </div>
                    
                    <div id="favGrid" class="grid grid-cols-3 gap-3"></div>
                    <div id="emptyFav" class="hidden text-center py-20">
                        <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-heart-broken text-2xl text-gray-600"></i>
                        </div>
                        <p class="text-gray-500 text-xs">æš‚æ— æ”¶è—ï¼Œå¿«å»æ·»åŠ å§</p>
                    </div>
                </div>
                
                <!-- æ™®é€šç‚¹æ’­æ’­æ”¾é¡µ -->
                <div id="playView" class="hidden">
                    <div class="relative w-full aspect-video bg-black sticky top-[60px] z-[1100]">
                        <iframe id="mainPlayer" class="w-full h-full border-none" allowfullscreen></iframe>
                        <div id="playerLoading" class="absolute inset-0 flex items-center justify-center bg-slate-950 hidden">
                            <div class="loader"></div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-2">
                            <h1 id="pTitle" class="text-xl font-black text-white leading-tight flex-1 mr-4">è½½å…¥ä¸­...</h1>
                            <button onclick="toggleFav()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center active:scale-90 transition-transform">
                                <i id="favIcon" class="far fa-heart text-white text-lg"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center gap-2 mb-6">
                            <button onclick="goHome()" class="text-[10px] font-bold text-gray-500 uppercase bg-white/5 px-2 py-1 rounded flex items-center gap-1 hover:text-white">
                                <i class="fas fa-chevron-left"></i>è¿”å›
                            </button>
                            <span id="playerSourceTag" class="text-[10px] text-red-500 font-bold px-2 py-1 bg-red-500/10 rounded">æé€Ÿè“å…‰</span>
                        </div>
                        
                        <div id="liveFallback" class="hidden mb-6">
                             <a id="directPlayLink" href="#" target="_blank" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all">
                                <i class="fas fa-external-link-alt"></i> ç½‘é¡µæ— æ³•æ’­æ”¾ï¼Ÿç‚¹å‡»è·³è½¬æ’­æ”¾
                            </a>
                            <p class="text-[9px] text-gray-500 text-center mt-2">æç¤ºï¼šç”±äºå®‰å…¨ç­–ç•¥ï¼Œéƒ¨åˆ†ç›´æ’­æºéœ€è·³è½¬åˆ°åŸç”Ÿæ’­æ”¾å™¨</p>
                        </div>

                        <!-- æ°›å›´ç»„ï¼šè™šæ‹Ÿè¯„è®ºåŒº -->
                        <div class="mb-8">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="w-1 h-3 bg-purple-500 rounded-full"></span>
                                <h3 class="text-sm font-black text-white">å®æ—¶çƒ­è¯„ <span class="text-[10px] text-gray-500 font-normal ml-1">99+</span></h3>
                            </div>
                            <div id="commentSection" class="h-32 overflow-hidden relative bg-white/5 rounded-xl p-3 comment-scroll">
                                <div id="commentList" class="flex flex-col gap-2"></div>
                            </div>
                        </div>

                        <div id="epList" class="grid grid-cols-3 gap-2 mb-8 mt-4"></div>
                        <div class="bg-white/5 p-4 rounded-2xl mb-10 relative">
                            <!-- AI å‰§æƒ…è¯¦è§£æŒ‰é’® -->
                            <button onclick="handleAIPlot()" class="absolute top-2 right-2 ai-sparkle px-2 py-1 rounded text-[10px] font-bold text-white flex items-center gap-1 hover:scale-105 transition-transform z-10">
                                <i class="fas fa-magic"></i> AI å‰§æƒ…è¯¦è§£
                            </button>
                            <p id="pContent" class="text-xs text-gray-400 leading-relaxed min-h-[60px]">æ­£åœ¨åŠ è½½å‰§æƒ…ä¿¡æ¯...</p>
                        </div>

                        <div class="mt-10">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-2">
                                    <span class="w-1 h-4 bg-amber-500 rounded-full"></span>
                                    <h3 class="text-lg font-black text-white">éšæœºæ¨èä½œå“</h3>
                                </div>
                                <button onclick="refreshRecommend()" class="text-xs text-amber-500 font-bold flex items-center gap-1 active:rotate-180 transition-transform duration-500 cursor-pointer">
                                    <i class="fas fa-sync-alt"></i> æ¢ä¸€æ‰¹
                                </button>
                            </div>
                            <div id="recommendGrid" class="grid grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>
            </main>

            <nav class="bottom-nav glass fixed-w-limit">
                <a href="javascript:void(0)" onclick="switchTab('home')" class="nav-item active" id="tab-home"><i class="fas fa-home"></i><span>ç²¾é¸</span></a>
                <a href="javascript:void(0)" onclick="switchTab('live')" class="nav-item" id="tab-live"><i class="fas fa-tv"></i><span>ç›´æ’­</span></a>
                <a href="javascript:void(0)" onclick="switchTab('rank')" class="nav-item" id="tab-rank"><i class="fas fa-chart-line"></i><span>æ¦œå–®</span></a>
                <a href="javascript:void(0)" onclick="switchTab('profile')" class="nav-item" id="tab-profile"><i class="fas fa-user"></i><span>æˆ‘çš„</span></a>
            </nav>

            <div id="searchOverlay" class="fixed inset-0 z-[2000] glass flex-col p-6 hidden fixed-w-limit">
                <div class="flex items-center gap-2 mb-8">
                    <div class="relative flex-1">
                        <input id="mobileSearchInput" type="text" placeholder="è¯•è¯•ï¼šæˆ‘æƒ³çœ‹å‘¨æ˜Ÿé©°çš„æç¬‘ç”µå½±..." class="w-full bg-white/10 border border-white/10 rounded-full py-3 pl-6 pr-24 focus:outline-none text-white text-sm">
                        <!-- AI æœç‰‡æŒ‰é’® -->
                        <button onclick="handleAISearch()" class="absolute right-1 top-1/2 -translate-y-1/2 ai-sparkle px-3 py-1.5 rounded-full text-[10px] font-bold text-white flex items-center gap-1 hover:scale-105 transition-transform">
                            <i class="fas fa-magic"></i> AI æœç‰‡
                        </button>
                    </div>
                    <button onclick="toggleSearch()" class="text-gray-400 font-bold text-sm cursor-pointer hover:text-white px-2">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full text-[10px] font-black text-white opacity-0 transition-all z-[3000] pointer-events-none fixed-w-limit"></div>

    <script>
        const RAW_SOURCES = [
            { name: 'ç„¡æ°´å°æº', url: 'https://api.wsyzy.net/api.php/provide/vod/', parser: 'https://wsyzy.top/m3u8/?url=' },
            { name: 'å¤§å¥¶è³‡æº', url: 'https://apidanaizi.com/api.php/provide/vod/', parser: 'https://jiexidanaizi.com/?url=' },
            { name: 'å¥¶é¦™å°ˆæº', url: 'https://naixxzy.com/api.php/provide/vod/', parser: 'https://mtjiexi.cc:966/?url=' },
            { name: 'å¹¸è³‡æº', url: 'https://xzybb1.com/api.php/provide/vod/', parser: 'https://19xzy.com/?url=' },
            { name: 'æ¥µé€Ÿè—å…‰', url: 'https://www.huyaapi.com/api.php/provide/vod/from/hym3u8/at/json', parser: 'https://huyajx.com/play/?url=' },
            { name: 'é­”éƒ½è³‡æº', url: 'https://www.mdzyapi.com/api.php/provide/vod/', parser: 'https://jiexi.modujx01.com/?url=' },
            { name: 'æ–°æµªè³‡æº', url: 'https://api.xinlangapi.com/xinlangapi.php/provide/vod/from/xlm3u8/at/json', parser: 'https://www.xinlangjiexi.com/m3u8/?url=' }
        ];

        // æ ¸å¿ƒæ›´æ–°ï¼šç§»é™¤äº† mitv:// åè®®çš„æºï¼Œæ¢å¤å¹¶æ‰©å……äº†æ ‡å‡† HTTP/HTTPS ç›´æ’­æº
        const ADULT_LIVE = [
            { name: "Live Cams", url: "http://cdn.adultiptv.net/livecams.m3u8" },
            { name: "Asian", url: "http://cdn.adultiptv.net/asian.m3u8" },
            { name: "Amateur", url: "http://cdn.adultiptv.net/amateur.m3u8" },
            { name: "Anal", url: "http://cdn.adultiptv.net/anal.m3u8" },
            { name: "Big Ass", url: "http://cdn.adultiptv.net/bigass.m3u8" },
            { name: "Big Dick", url: "http://cdn.adultiptv.net/bigdick.m3u8" },
            { name: "Big Tits", url: "http://cdn.adultiptv.net/bigtits.m3u8" },
            { name: "Bisexual", url: "http://cdn.adultiptv.net/bisexual.m3u8" },
            { name: "Blonde", url: "http://cdn.adultiptv.net/blonde.m3u8" },
            { name: "Blowjob", url: "http://cdn.adultiptv.net/blowjob.m3u8" },
            { name: "Bondage", url: "http://cdn.adultiptv.net/bondage.m3u8" },
            { name: "Brunette", url: "http://cdn.adultiptv.net/brunette.m3u8" },
            { name: "Compilation", url: "http://cdn.adultiptv.net/compilation.m3u8" },
            { name: "Cosplay", url: "http://cdn.adultiptv.net/cosplay.m3u8" },
            { name: "Couples", url: "http://cdn.adultiptv.net/couples.m3u8" },
            { name: "Creampie", url: "http://cdn.adultiptv.net/creampie.m3u8" },
            { name: "Cuckold", url: "http://cdn.adultiptv.net/cuckold.m3u8" },
            { name: "Ebony", url: "http://cdn.adultiptv.net/ebony.m3u8" },
            { name: "Fetish", url: "http://cdn.adultiptv.net/fetish.m3u8" },
            { name: "Gangbang", url: "http://cdn.adultiptv.net/gangbang.m3u8" },
            { name: "Gay", url: "http://cdn.adultiptv.net/gay.m3u8" },
            { name: "Hardcore", url: "http://cdn.adultiptv.net/hardcore.m3u8" },
            { name: "Hentai", url: "http://cdn.adultiptv.net/hentai.m3u8" },
            { name: "Interracial", url: "http://cdn.adultiptv.net/interracial.m3u8" },
            { name: "Latina", url: "http://cdn.adultiptv.net/latina.m3u8" },
            { name: "Lesbian", url: "http://cdn.adultiptv.net/lesbian.m3u8" },
            { name: "Mature", url: "http://cdn.adultiptv.net/mature.m3u8" },
            { name: "MILF", url: "http://cdn.adultiptv.net/milf.m3u8" },
            { name: "Pornstar", url: "http://cdn.adultiptv.net/pornstar.m3u8" },
            { name: "POV", url: "http://cdn.adultiptv.net/pov.m3u8" },
            { name: "Public", url: "http://cdn.adultiptv.net/public.m3u8" },
            { name: "Rough", url: "http://cdn.adultiptv.net/rough.m3u8" },
            { name: "Russian", url: "http://cdn.adultiptv.net/russian.m3u8" },
            { name: "Striptease", url: "http://cdn.adultiptv.net/striptease.m3u8" },
            { name: "Teen", url: "http://cdn.adultiptv.net/teen.m3u8" },
            { name: "Threesome", url: "http://cdn.adultiptv.net/threesome.m3u8" },
            { name: "Transgender", url: "http://cdn.adultiptv.net/transgender.m3u8" },
            { name: "VR Porn", url: "http://cdn.adultiptv.net/vr.m3u8" },
            { name: "XXX Mix", url: "https://d12a2vxqkkh1bo.cloudfront.net/hls/1080p/playlist.m3u8" }
        ];

        const GLOBAL_LIVE = [
            { name: "ã€HBOã€‘Asia", url: "https://dai.google.com/linear/hls/event/w8_7s433R_6X9_S433R_6g/master.m3u8" },
            { name: "ã€Discoveryã€‘Science", url: "https://d2e1asnsl7br7b.cloudfront.net/7782e205e72f43aeb4a48ec97f66ebbe/index_5.m3u8" },
            { name: "ã€Nat Geoã€‘Wild", url: "https://wildearth-plex.amagi.tv/masterR1080p.m3u8" },
            { name: "ã€MTVã€‘Music", url: "https://stream-us-east-1.getpublica.com/playlist.m3u8?network_id=53" },
            { name: "ã€K-POPã€‘SBS M", url: "https://sbs-live.akamaized.net/hls/live/2002381/sbs_m/playlist.m3u8" },
            { name: "ã€æ—¥æœ¬ã€‘NHK World", url: "https://nhkwlive-ojp.akamaized.net/hls/live/2003459/nhkwlive-ojp-en/index.m3u8" },
            { name: "ã€æ—¥æœ¬ã€‘å¯Œå£«ç”µè§†å°", url: "https://fujitv4.mov3.co/hls/fujitv.m3u8" },
            { name: "ã€æ—¥æœ¬ã€‘TBS", url: "https://tbs4.mov3.co/hls/tbs.m3u8" },
            { name: "ã€éŸ©å›½ã€‘é˜¿é‡Œéƒ Arirang", url: "http://amdlive.ctnd.com.edgesuite.net/arirang_1ch/smil:arirang_1ch.smil/chunklist_b656000_sleng.m3u8" },
            { name: "ã€éŸ©å›½ã€‘KBS World", url: "https://kbsworld-ott.akamaized.net/hls/live/2002341/kbsworld/master.m3u8" },
            { name: "ã€ç¾å›½ã€‘NASA TV", url: "https://ntv1.akamaized.net/hls/live/2014075/NASA-NTV1-HLS/master.m3u8" },
            { name: "ã€ç¾å›½ã€‘Bloomberg å½­åš", url: "https://liveproduseast.akamaized.net/us/Channel-USTV-AWS-virginia-1/Source-USTV-1000-1_live.m3u8" },
            { name: "ã€ç¾å›½ã€‘FOX News", url: "https://fox-foxnewsnow-samsungus.amagi.tv/playlist.m3u8" },
            { name: "ã€ç¾å›½ã€‘ABC News", url: "https://abcnews-streams.akamaized.net/hls/live/2023560/abcnews1/master.m3u8" },
            { name: "ã€æ³•å›½ã€‘France 24", url: "http://static.france24.com/live/F24_EN_LO_HLS/live_web.m3u8" },
            { name: "ã€æ³•å›½ã€‘Fashion TV", url: "http://91.247.68.229:8000/play/Fashion/index.m3u8" },
            { name: "ã€åŠå²›ã€‘Al Jazeera", url: "http://live-hls-web-aje.getaj.net/AJE/01.m3u8" },
            { name: "ã€ä¿„ç½—æ–¯ã€‘RT News", url: "https://rt-glb.rttv.com/live/rtnews/playlist.m3u8" },
            { name: "ã€ä¿„ç½—æ–¯ã€‘RT Doc", url: "https://rt-rtd.rttv.com/live/rtdoc/playlist.m3u8" },
            { name: "ã€å°åº¦ã€‘NDTV 24x7", url: "https://ndtv24x7elemarchana.akamaized.net/hls/live/2003678/ndtv24x7/master.m3u8" },
            { name: "ã€å·´è¥¿ã€‘Novo Tempo", url: "http://stream.novotempo.com/tv/tvnovotempo.smil/playlist.m3u8" },
            { name: "ã€å¾·å›½ã€‘1-2-3 TV", url: "http://123tv.cdn.ses-ps.com/index.m3u8" },
            { name: "ã€å°æ¹¾ã€‘Taiwan Plus", url: "https://bcovlive-a.akamaihd.net/rce33d845cb9e42dfa302c7ac345f7858/ap-northeast-1/6282251407001/playlist.m3u8" },
            { name: "ã€æ–°åŠ å¡ã€‘CNA News", url: "https://d2e1asnsl7br7b.cloudfront.net/7782e205e72f43aeb4a48ec97f66ebbe/index_5.m3u8" },
            { name: "ã€Wild Earthã€‘", url: "https://wildearth-plex.amagi.tv/masterR1080p.m3u8" },
            { name: "ã€Fight Networkã€‘", url: "https://d12a2vxqkkh1bo.cloudfront.net/hls/1080p/playlist.m3u8" },
            { name: "ã€Love Nature 4Kã€‘", url: "https://d18dyiwu97wm6q.cloudfront.net/playlist2160p.m3u8" }
        ];

        // â˜…â˜…â˜…â˜…â˜… FIREBASE é…ç½®å€åŸŸ â˜…â˜…â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyADOBqIzpJzN1iebUj-Sg_-3tONftiX-E0",
            authDomain: "device-streaming-3dbbebb8.firebaseapp.com",
            projectId: "device-streaming-3dbbebb8",
            storageBucket: "device-streaming-3dbbebb8.firebasestorage.app",
            messagingSenderId: "768460898395",
            appId: "1:768460898395:web:b456c8dcbc13095df8ff7e"
        };

        const GEMINI_API_KEY = ""; // ç³»ç»Ÿä¼šè‡ªåŠ¨æ³¨å…¥ Key

        let CONFIG = { sources: [], proxies: [(url) => `https://corsproxy.io/?${encodeURIComponent(url)}`, (url) => url] };
        let state = {
            page: 1, typeId: '', keyword: '', activeSourceIdx: 0,
            movies: [], classes: [], swiper: null, currentTab: 'home',
            allPool: [], mode: 'none', current: null, favorites: [], user: null, db: null,
            liveList: [], liveIndex: 0, liveDp: null, touchStartY: 0, commentInterval: null, dp: null,
            previewInterval: null
        };

        // --- GEMINI AI é€»è¾‘ ---
        
        async function callGemini(prompt) {
            if (!GEMINI_API_KEY) {
                console.warn("Gemini API Key missing");
                return null;
            }
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("Gemini Error:", error);
                return null;
            }
        }

        async function handleAISearch() {
            const input = document.getElementById('mobileSearchInput');
            const userQuery = input.value.trim();
            if (!userQuery) return showToast('è¯·å…ˆè¾“å…¥æ‚¨æƒ³çœ‹çš„å†…å®¹æè¿°');
            
            showToast('AI æ­£åœ¨æ€è€ƒä¸­...');
            input.value = "AI æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚...";
            input.disabled = true;

            const prompt = `ä½ æ˜¯ä¸€ä¸ªå½±è§†æœç´¢åŠ©æ‰‹ã€‚ç”¨æˆ·æƒ³çœ‹ï¼š"${userQuery}"ã€‚è¯·åˆ†æç”¨æˆ·æ„å›¾ï¼Œæä¾›1ä¸ªæœ€å¯èƒ½åœ¨å½±è§†èµ„æºç«™ï¼ˆé€šå¸¸ä½¿ç”¨ä¸­æ–‡ç‰‡åï¼‰æœåˆ°èµ„æºçš„ä¸­æ–‡å…³é”®è¯ã€‚å¦‚æœç”¨æˆ·æè¿°çš„æ˜¯ç±»å‹ï¼ˆå¦‚â€œææ€–ç‰‡â€ï¼‰ï¼Œå°±è¿”å›ç±»å‹è¯ï¼›å¦‚æœæ˜¯å…·ä½“ç”µå½±æè¿°ï¼Œå°±è¿”å›ç”µå½±åã€‚åªè¿”å›å…³é”®è¯ï¼Œä¸è¦æ ‡ç‚¹ç¬¦å·ï¼Œä¸è¦è§£é‡Šã€‚`;

            const keyword = await callGemini(prompt);
            
            input.disabled = false;
            if (keyword) {
                const cleanKeyword = keyword.replace(/\n/g, '').trim();
                input.value = cleanKeyword;
                state.keyword = cleanKeyword;
                state.page = 1;
                showToast(`AIä¸ºæ‚¨æ¨èå…³é”®è¯ï¼š${cleanKeyword}`);
                toggleSearch();
                fetchData(1);
            } else {
                input.value = userQuery;
                showToast('AI æš‚æ—¶æ— æ³•è¿æ¥ï¼Œå·²ä½¿ç”¨åŸè¯æœç´¢');
                state.keyword = userQuery;
                state.page = 1;
                toggleSearch();
                fetchData(1);
            }
        }

        async function handleAIPlot() {
            if (!state.current) return;
            const pContent = document.getElementById('pContent');
            const originalText = pContent.innerText;
            pContent.innerHTML = '<span class="animate-pulse">âœ¨ AI æ­£åœ¨æ’°å†™å‰§æƒ…...</span>';
            
            const prompt = `è¯·ç”¨ä¸­æ–‡ç®€è¦ä»‹ç»å½±è§†ä½œå“ã€Š${state.current.vod_name}ã€‹çš„å‰§æƒ…æ¢—æ¦‚ã€‚è¦æ±‚ï¼š100å­—ä»¥å†…ï¼Œè¯­è¨€ç”ŸåŠ¨å¸å¼•äººï¼Œé€‚åˆä½œä¸ºå½±è§†æ¨èæ–‡æ¡ˆã€‚ä¸è¦å‰§é€ç»“å±€ã€‚`;
            
            const summary = await callGemini(prompt);
            
            if (summary) {
                pContent.innerText = summary;
                showToast('AI å‰§æƒ…ç”Ÿæˆå®Œæ¯•');
            } else {
                pContent.innerText = originalText;
                showToast('AI ç”Ÿæˆå¤±è´¥');
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ ---
        
        function goHome() { 
            const iframe = document.querySelector('#playView iframe');
            if (iframe) iframe.src = ''; 
            if (state.dp) { state.dp.destroy(); state.dp = null; }
            if (state.liveDp) { state.liveDp.destroy(); state.liveDp = null; }
            if (state.commentInterval) clearInterval(state.commentInterval);
            if (state.previewInterval) clearInterval(state.previewInterval); // åœæ­¢é¢„è§ˆåˆ·æ–°
            switchTab('home'); 
        }

        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity='1'; t.style.bottom='100px'; setTimeout(()=>{t.style.opacity='0'; t.style.bottom='80px'},2000); }

        function handleLogin() {
            const acc = document.getElementById('accountInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();
            if (!acc || !pass) return showToast('è¯·è¾“å…¥è´¦å·å¯†ç ');
            
            const email = `${acc}@naixx.com`;
            const safePass = pass.length < 6 ? pass + 'naixx' : pass;
            
            if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => firebase.auth().signInWithEmailAndPassword(email, safePass))
                .then(cre => finishLogin(cre.user, acc))
                .catch(err => {
                    if(err.code.includes('not-found') || err.code.includes('invalid')) {
                         firebase.auth().createUserWithEmailAndPassword(email, safePass)
                            .then(cre => finishLogin(cre.user, acc))
                            .catch(e => showToast('æ³¨å†Œå¤±è´¥: ' + e.message));
                    } else showToast('ç™»å½•å¤±è´¥');
                });
        }

        function finishLogin(user, acc) {
            state.user = user;
            if(acc === '1996') { localStorage.setItem('naixx_auth_mode', 'full'); unlockSite('full'); }
            else if(acc === '199688') { localStorage.setItem('naixx_auth_mode', 'safe'); unlockSite('safe'); }
            else { localStorage.setItem('naixx_auth_mode', 'safe'); unlockSite('safe'); }
        }

        function unlockSite(mode) {
            document.getElementById('passwordView').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('opacity-100');
            state.mode = mode;
            
            if(mode === 'safe') {
                CONFIG.sources = [RAW_SOURCES[4]]; 
                document.getElementById('appTitle').innerText = 'BlueRay TV';
                document.getElementById('adultLiveSection').classList.add('hidden'); 
            } else {
                CONFIG.sources = RAW_SOURCES;
                document.getElementById('appTitle').innerText = 'NAIXX TV';
                document.getElementById('adultLiveSection').classList.remove('hidden'); 
            }
            
            renderLiveSection();
            initApp();
            initDatabase();
        }

        function initDatabase() {
             if (firebaseConfig.apiKey) {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    state.db = firebase.firestore();
                    const auth = firebase.auth();
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            state.user = user;
                            const status = document.getElementById('cloudStatus');
                            if(status) status.innerText = 'äº‘ç«¯åŒæ­¥ä¸­';
                            const uidDisplay = document.getElementById('userIdDisplay');
                            if(uidDisplay) uidDisplay.innerText = `ID: ${user.uid.substring(0,8)}...`;
                            
                            state.db.collection('users').doc(user.uid).collection('favorites')
                                .onSnapshot((snapshot) => {
                                    state.favorites = [];
                                    snapshot.forEach(doc => state.favorites.push(doc.data()));
                                    state.favorites.sort((a, b) => b.timestamp - a.timestamp);
                                    if (state.currentTab === 'profile') renderProfile();
                                });
                        }
                    });
                } catch(e) { console.log(e); }
             }
        }

        // ä¿®æ”¹ï¼šåŒåˆ—ç½‘æ ¼æ¸²æŸ“ + é¢„è§ˆå›¾é€»è¾‘
        function renderLiveSection() {
            // æ¸²æŸ“æˆäººåŒºï¼ˆç½‘æ ¼å¸¦é¢„è§ˆï¼‰
            document.getElementById('adultLiveGrid').innerHTML = ADULT_LIVE.map((c,i) => {
                // ç”Ÿæˆä¸€ä¸ªéšæœºçš„å ä½ç¬¦IDï¼Œæ¨¡æ‹Ÿä¸åŒçš„é¢‘é“å°é¢
                const seed = 100 + i; 
                return `
                <div onclick="startLivePlay('adult', ${i})" class="relative group cursor-pointer overflow-hidden rounded-xl bg-gray-800 aspect-video shadow-lg active:scale-95 transition-transform">
                    <img id="live-preview-${i}" src="https://picsum.photos/300/200?random=${seed}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                    <div class="absolute top-2 right-2 bg-red-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded animate-pulse">â— LIVE</div>
                    <div class="absolute bottom-2 left-2 right-2">
                        <h4 class="text-white text-xs font-bold truncate text-shadow">${c.name}</h4>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="text-[8px] bg-white/20 px-1 rounded text-gray-300">HD</span>
                            <span class="text-[8px] text-pink-400">æ­£åœ¨æ’­æ”¾...</span>
                        </div>
                    </div>
                </div>
            `}).join('');

            // æ¸²æŸ“å…¨çƒå«è§†ï¼ˆä¿æŒåˆ—è¡¨ï¼‰
            document.getElementById('globalLiveGrid').innerHTML = GLOBAL_LIVE.map((c,i) => `
                <div onclick="startLivePlay('global', ${i})" class="live-card p-3 rounded-xl flex items-center gap-3 active:scale-95 transition-transform">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white"><i class="fas fa-globe"></i></div>
                    <div class="flex-1 text-white text-sm font-bold">${c.name}</div>
                    <div class="text-[10px] live-badge px-2 rounded text-white font-bold">4K</div>
                </div>
            `).join('');
        }

        // æ–°å¢ï¼šæ¨¡æ‹Ÿé¢„è§ˆå›¾å®æ—¶åˆ·æ–°
        function startPreviewRefresher() {
            if (state.previewInterval) clearInterval(state.previewInterval);
            
            // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡å›¾ç‰‡ï¼Œæ¨¡æ‹Ÿå®æ—¶ç›´æ’­å¸§
            state.previewInterval = setInterval(() => {
                if(state.currentTab !== 'live') return;
                
                // éšæœºæŒ‘é€‰å‡ ä¸ªå¡ç‰‡è¿›è¡Œåˆ·æ–°ï¼Œé¿å…å…¨éƒ¨åŒæ—¶é—ªçƒå¤ªå‡
                const count = ADULT_LIVE.length;
                const indexesToRefresh = Array.from({length: 3}, () => Math.floor(Math.random() * count));
                
                indexesToRefresh.forEach(idx => {
                    const img = document.getElementById(`live-preview-${idx}`);
                    if(img) {
                        const newTime = Date.now();
                        // é‡æ–°åŠ è½½å›¾ç‰‡ï¼Œæ·»åŠ  class è§¦å‘åŠ¨ç”»
                        img.src = `https://picsum.photos/300/200?random=${idx}&t=${newTime}`;
                        img.classList.remove('preview-refresh');
                        void img.offsetWidth; // è§¦å‘é‡ç»˜
                        img.classList.add('preview-refresh');
                    }
                });
            }, 5000);
        }

        function startLivePlay(type, index) {
            state.liveList = type === 'adult' ? ADULT_LIVE : GLOBAL_LIVE;
            state.liveIndex = index;
            document.getElementById('liveRoom').classList.remove('hidden');
            document.querySelector('header').classList.add('-translate-y-full');
            document.querySelector('nav').classList.add('translate-y-full');
            
            // æ˜¾ç¤º Loading
            document.getElementById('liveLoadingIndicator').classList.remove('hidden');
            
            renderEpg();
            
            // æ ¸å¿ƒä¿®å¤ï¼šå»¶è¿Ÿåˆå§‹åŒ–æ’­æ”¾å™¨ï¼Œè§£å†³é»‘å±é—®é¢˜
            setTimeout(() => {
                playCurrentLive();
            }, 300); // 300ms å»¶è¿Ÿï¼Œç­‰å¾… DOM åŠ¨ç”»å®Œæˆ
            
            const touchArea = document.getElementById('liveTouchArea');
            touchArea.addEventListener('touchstart', e => state.touchStartY = e.touches[0].clientY);
            touchArea.addEventListener('touchend', e => {
                const diff = state.touchStartY - e.changedTouches[0].clientY;
                if (Math.abs(diff) > 50) { 
                    if (diff > 0) nextChannel(); 
                    else prevChannel(); 
                }
            });
        }

        function playCurrentLive() {
            const channel = state.liveList[state.liveIndex];
            document.getElementById('liveChannelName').innerText = channel.name;
            document.querySelectorAll('.epg-item').forEach(el => el.classList.remove('active'));
            const currentEpg = document.getElementById(`epg-${state.liveIndex}`);
            if(currentEpg) currentEpg.classList.add('active');
            changeLiveLine(0);
        }
        
        function nextChannel() {
            if (state.liveIndex < state.liveList.length - 1) { state.liveIndex++; playCurrentLive(); showToast(`åˆ‡æ¢è‡³: ${state.liveList[state.liveIndex].name}`); }
            else showToast('å·²ç»æ˜¯æœ€åä¸€ä¸ªé¢‘é“äº†');
        }
        
        function prevChannel() {
            if (state.liveIndex > 0) { state.liveIndex--; playCurrentLive(); showToast('åˆ‡æ¢é¢‘é“...'); }
            else showToast('å·²ç»æ˜¯ç¬¬ä¸€ä¸ªé¢‘é“äº†');
        }

        function changeLiveLine(lineIdx) {
            const url = state.liveList[state.liveIndex].url;
            const safeUrl = url.replace('mitv://', 'http://'); // è‡ªåŠ¨åè®®ä¿®æ­£
            const container = document.getElementById('livePlayerContainer');
            
            // é”€æ¯æ—§å®ä¾‹
            if(state.liveDp) { 
                state.liveDp.destroy(); 
                state.liveDp = null; 
            }
            container.innerHTML = '';
            document.getElementById('liveLoadingIndicator').classList.remove('hidden');

            // æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿å®¹å™¨æ¸…ç©ºåå†åˆå§‹åŒ–
            setTimeout(() => {
                if (lineIdx === 0) {
                    try {
                        state.liveDp = new DPlayer({ 
                            container: container, 
                            live: true, 
                            video: { url: safeUrl, type: 'hls' }, 
                            autoplay: true, 
                            theme: '#e50914' 
                        });
                        
                        // ç›‘å¬åŠ è½½äº‹ä»¶
                        state.liveDp.on('canplay', () => {
                            document.getElementById('liveLoadingIndicator').classList.add('hidden');
                            state.liveDp.play(); // å¼ºåˆ¶æ’­æ”¾
                        });
                        
                        state.liveDp.on('error', () => { 
                            showToast('ç›´è¿å¤±è´¥ï¼Œå°è¯•è§£ææ¨¡å¼...'); 
                            changeLiveLine(1); 
                        });
                    } catch(e) {
                        console.error(e);
                        changeLiveLine(1);
                    }
                } else {
                    // è§£ææ¨¡å¼
                    const iframe = document.createElement('iframe');
                    iframe.className = "w-full h-full border-none";
                    iframe.src = 'https://www.playm3u8.cn/jiexi.php?url=' + encodeURIComponent(safeUrl);
                    iframe.onload = () => document.getElementById('liveLoadingIndicator').classList.add('hidden');
                    container.appendChild(iframe);
                }
            }, 100);
        }

        function renderEpg() {
            const list = document.getElementById('epgList');
            // å®‰å…¨ä¿®å¤
            list.innerHTML = state.liveList.map((c, i) => `
                <div id="epg-${i}" class="epg-item ${i === state.liveIndex ? 'active' : ''}" onclick="state.liveIndex=${i}; playCurrentLive(); toggleEpg()">
                    <span>${c.name}</span>
                    ${i === state.liveIndex ? '<i class="fas fa-signal"></i>' : ''}
                </div>
            `).join('');
        }

        function toggleEpg() { document.getElementById('epgSidebar').classList.toggle('open'); }

        function exitLiveRoom() {
            document.getElementById('liveRoom').classList.add('hidden');
            if(state.liveDp) { state.liveDp.destroy(); state.liveDp = null; }
            document.getElementById('livePlayerContainer').innerHTML = '';
            document.querySelector('header').classList.remove('-translate-y-full');
            document.querySelector('nav').classList.remove('translate-y-full');
        }

        async function initApp() { await loadClasses(); fetchData(); }
        
        async function loadClasses() {
            let baseUrl = CONFIG.sources[state.activeSourceIdx].url.replace('at/json','').replace('at/xml','');
            const url = `${baseUrl}${baseUrl.includes('?')?'&':'?'}ac=list`;
            const data = await fastRaceFetch(url);
            if(data && data.class) { state.classes = data.class; renderFilters(); }
        }
        
        async function fetchData(page=1) {
            const container = document.getElementById('movieGrid');
            if(page===1) container.innerHTML = Array(6).fill('<div class="skeleton aspect-[2/3] rounded-2xl"></div>').join('');
            
            const source = CONFIG.sources[state.activeSourceIdx].url;
            
            // ä¿®å¤æœç´¢å‚æ•°æ„é€ ï¼Œå¤„ç†æºå¯èƒ½ä¸æ”¯æŒæœç´¢çš„æƒ…å†µ
            const target = `${source}?ac=detail&pg=${page}${state.typeId?'&t='+state.typeId:''}${state.keyword?'&wd='+state.keyword:''}`;
            
            const data = await fastRaceFetch(target);
            
            if(data && data.list) {
                state.movies = data.list;
                state.page = page;
                renderGrid();
                renderRecommend();
            } else {
                if(page === 1) {
                    // å¦‚æœæ˜¯ç¬¬ä¸€é¡µä¸”æ²¡æœ‰æ•°æ®ï¼ˆå¯èƒ½æºæŠ¥é”™äº†ï¼‰ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
                    if(state.keyword) {
                         container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-10 flex flex-col items-center"><i class="fas fa-search-minus text-4xl mb-2"></i><p>æœªæ‰¾åˆ°ç›¸å…³å†…å®¹æˆ–æºæš‚ä¸æ”¯æŒæœç´¢</p><button onclick="switchSource((state.activeSourceIdx + 1) % CONFIG.sources.length)" class="mt-4 text-xs bg-red-600 px-3 py-1 rounded text-white">åˆ‡æ¢æºé‡è¯•</button></div>';
                    } else {
                         container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-10">æš‚æ— æ•°æ®æˆ–åŠ è½½å¤±è´¥</div>';
                    }
                }
            }
        }

        async function fastRaceFetch(url) {
            try {
                // å®‰å…¨è§£æ JSON
                const resp = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!resp.ok) throw new Error('Fetch failed');
                const text = await resp.text(); // å…ˆå–æ–‡æœ¬ï¼Œé˜²æ­¢ JSON è§£æå´©æ½°
                
                // ç®€å•æ£€æŸ¥æ˜¯å¦å¯èƒ½æ˜¯JSON
                if (text.trim().startsWith('{')) {
                    try {
                        return JSON.parse(text);
                    } catch(e) {
                        console.warn("JSON Parse Warning: Response might not be valid JSON", text.substring(0, 50));
                        return null;
                    }
                } else {
                    console.warn("API returned non-JSON text:", text.substring(0, 50));
                    return null;
                }
            } catch(e) { console.error(e); return null; }
        }

        function renderFilters() {
             document.getElementById('cateFilters').innerHTML = 
                `<button onclick="state.typeId='';fetchData(1)" class="pill ${!state.typeId?'active':''}">å…¨éƒ¨</button>` + 
                state.classes.map(c => `<button onclick="state.typeId=${c.type_id};fetchData(1)" class="pill ${state.typeId==c.type_id?'active':''}">${c.type_name}</button>`).join('');
             document.getElementById('sourceFilters').innerHTML = 
                CONFIG.sources.map((s,i) => `<button onclick="switchSource(${i})" class="pill ${state.activeSourceIdx===i?'active':''}">${s.name}</button>`).join('');
        }

        function renderGrid() {
            document.getElementById('movieGrid').innerHTML = state.movies.map((m,i) => `
                <div onclick="openPlayer(${i})" class="relative rounded-xl overflow-hidden aspect-[2/3] bg-gray-800">
                    <img src="${m.vod_pic}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/90 p-2">
                        <h3 class="text-xs text-white font-bold truncate">${m.vod_name}</h3>
                    </div>
                </div>
            `).join('');
        }
        
        function renderRecommend() {
             const container = document.getElementById('recommendGrid');
             if (!container) return; 
             const shuffled = [...state.movies].sort(()=>0.5-Math.random()).slice(0,6);
             container.innerHTML = shuffled.map(m => `
                 <div class="bg-white/5 p-2 rounded flex gap-2" onclick="openPlayerWithData(${JSON.stringify(m).replace(/"/g, '&quot;')})">
                     <img src="${m.vod_pic}" class="w-12 h-16 object-cover rounded">
                     <div class="flex-1 min-w-0">
                         <h4 class="text-xs text-white truncate">${m.vod_name}</h4>
                         <span class="text-[10px] text-red-500">HOT</span>
                     </div>
                 </div>
             `).join('');
        }

        function refreshRecommend() { if(document.getElementById('recommendGrid')) renderRecommend(); }

        function openPlayer(idx) {
            document.getElementById('homeView').style.display='none';
            document.getElementById('liveView').style.display='none';
            document.getElementById('playView').style.display='block';
            
            const m = state.movies[idx];
            state.current = m;
            const url = m.vod_play_url.split('$')[1];
            document.querySelector('#playView iframe').src = CONFIG.sources[state.activeSourceIdx].parser + url;
            
            document.getElementById('pTitle').innerText = m.vod_name;
            document.getElementById('playerSourceTag').innerText = CONFIG.sources[state.activeSourceIdx].name;
            updateFavIcon();
            startFakeComments();
            refreshRecommend();
            
            // é‡ç½® AI å‰§æƒ…
            document.getElementById('pContent').innerText = 'æ­£åœ¨è·å–èµ„æºä¿¡æ¯...';
        }
        
        async function switchSource(idx) { state.activeSourceIdx = idx; await initApp(); }

        function switchTab(tab) {
            ['home','live','rank','profile'].forEach(t => document.getElementById(t+'View').classList.add('hidden'));
            document.getElementById(tab+'View').classList.remove('hidden');
            document.getElementById('playView').style.display = 'none';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            
            // åˆ‡æ¢åˆ°ç›´æ’­Tabæ—¶å¯åŠ¨é¢„è§ˆåˆ·æ–°ï¼Œå¦åˆ™å…³é—­ä»¥èŠ‚çœæ€§èƒ½
            if(tab === 'live') {
                startPreviewRefresher();
            } else {
                if(state.previewInterval) clearInterval(state.previewInterval);
            }
            
            if (tab === 'profile') renderProfile();
        }
        
        function openPlayerWithData(m) {
            state.current = m;
            document.getElementById('homeView').style.display='none';
            document.getElementById('liveView').style.display='none';
            document.getElementById('playView').style.display='block';
            
            const url = m.vod_play_url.split('$')[1];
            document.querySelector('#playView iframe').src = CONFIG.sources[state.activeSourceIdx].parser + url;
            
            document.getElementById('pTitle').innerText = m.vod_name;
            updateFavIcon();
            startFakeComments();
            refreshRecommend();

            // é‡ç½® AI å‰§æƒ…
            document.getElementById('pContent').innerText = 'æ­£åœ¨è·å–èµ„æºä¿¡æ¯...';
        }

        function toggleSearch() {
            const el = document.getElementById('searchOverlay');
            el.classList.toggle('hidden');
            el.classList.toggle('flex');
            if (!el.classList.contains('hidden')) document.getElementById('mobileSearchInput').focus();
        }

        function handleLogout() { localStorage.removeItem('naixx_auth_mode'); location.reload(); }
        
        function updateNickname() {
            const currentName = state.user ? (state.user.displayName || "æˆ‘çš„æ”¶è—") : "æˆ‘çš„æ”¶è—";
            const newName = prompt("è¯·è¾“å…¥æ‚¨æƒ³æ˜¾ç¤ºçš„ä¸ªæ€§åŒ–æ˜µç§°:", currentName);
            if (newName && newName.trim() !== "") {
                document.getElementById('userNameDisplay').innerText = newName;
                if (state.user) state.user.updateProfile({ displayName: newName });
            }
        }

        // Profile & Fav Logic
        function renderProfile() {
            const grid = document.getElementById('favGrid');
            const empty = document.getElementById('emptyFav');
            
            // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°DOMå…ƒç´ ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…æŠ¥é”™
            if (!grid || !empty) return;

            if (state.favorites.length === 0) { grid.innerHTML = ''; empty.classList.remove('hidden'); }
            else {
                empty.classList.add('hidden');
                grid.innerHTML = state.favorites.map(m => `
                    <div class="movie-card animate-fade-in cursor-pointer" onclick="playFav(${JSON.stringify(m).replace(/"/g, '&quot;')})">
                        <div class="relative mb-2">
                            <img src="${m.vod_pic}" class="w-full rounded-lg aspect-[2/3] object-cover" onerror="this.src='https://via.placeholder.com/200x300?text=NAIXX'">
                            <div class="absolute top-1 right-1 bg-red-600 rounded-full w-5 h-5 flex items-center justify-center"><i class="fas fa-play text-[8px] text-white ml-0.5"></i></div>
                        </div>
                        <h3 class="text-[10px] font-bold text-gray-300 truncate">${m.vod_name}</h3>
                    </div>
                `).join('');
            }
        }
        
        function playFav(m) {
             if (m.sourceIdx !== undefined) state.activeSourceIdx = m.sourceIdx;
             openPlayerWithData(m);
        }

        function updateFavIcon() {
            if (!state.current) return;
            const isFav = state.favorites.some(m => m.vod_id === state.current.vod_id);
            const icon = document.getElementById('favIcon');
            icon.className = isFav ? 'fas fa-heart text-red-500 text-lg' : 'far fa-heart text-white text-lg';
        }

        function toggleFav() {
            if (!state.current) return;
            const isFav = state.favorites.some(m => m.vod_id === state.current.vod_id);
            const favData = { vod_id: state.current.vod_id, vod_name: state.current.vod_name, vod_pic: state.current.vod_pic, vod_play_url: state.current.vod_play_url, sourceIdx: state.activeSourceIdx, sourceName: CONFIG.sources[state.activeSourceIdx].name, timestamp: Date.now() };

            if (state.user && state.db) {
                if (isFav) {
                    state.db.collection('users').doc(state.user.uid).collection('favorites').doc(String(state.current.vod_id)).delete();
                    showToast('å·²ç§»é™¤äº‘ç«¯');
                } else {
                    state.db.collection('users').doc(state.user.uid).collection('favorites').doc(String(state.current.vod_id)).set(favData);
                    showToast('å·²åŒæ­¥è‡³äº‘ç«¯');
                }
            } else { showToast('è¯·å…ˆç™»å½•'); }
        }

        function addComment(list, comments) {
            const div = document.createElement('div');
            div.className = "flex items-start gap-2 animate-fade-in";
            div.innerHTML = `<div class="min-w-[24px] h-6 bg-white/10 rounded-full flex items-center justify-center"><i class="fas fa-user text-[10px] text-gray-400"></i></div><div class="flex-1"><p class="text-[10px] text-gray-400 mt-0.5 leading-tight">${comments[Math.floor(Math.random()*comments.length)]}</p></div>`;
            list.insertBefore(div, list.firstChild);
        }

        function startFakeComments() {
            if (state.commentInterval) clearInterval(state.commentInterval);
            const list = document.getElementById('commentList');
            list.innerHTML = ''; 
            const comments = ["è¿™é€Ÿåº¦ç»äº†ï¼ç§’æ’­å•Š", "ç”»è´¨å¾ˆé¡¶ï¼Œæ”¯æŒç«™é•¿", "ç»ˆäºæ‰¾åˆ°è¿™éƒ¨äº†ï¼Œæ„Ÿè°¢åˆ†äº«", "æ— å¹¿å‘ŠçœŸçš„çˆ½", "VIP888è·¯è¿‡ï¼Œè¿™ç‰‡å­ä¸é”™", "å‰§æƒ…ç¥åè½¬ï¼Œæ¨è", "æ™šä¸Šå°±é è¿™ä¸ªç»­å‘½äº†", "è‰¯å¿ƒç½‘ç«™ï¼Œå·²æ”¶è—", "åŠ è½½çœŸå¿«", "è¿™ä¸ªå¥³ä¸»è§’æ˜¯è°ï¼Ÿ"];
            for(let i=0; i<4; i++) addComment(list, comments);
            state.commentInterval = setInterval(() => {
                addComment(list, comments);
                if(list.children.length > 20) list.removeChild(list.lastElementChild);
            }, 2500);
        }

        // å®‰å…¨ç»‘å®šå›è½¦äº‹ä»¶
        const searchInput = document.getElementById('mobileSearchInput');
        if (searchInput) {
            searchInput.onkeypress = (e) => { 
                if (e.key === 'Enter') { 
                    state.keyword = e.target.value; 
                    state.page = 1; 
                    toggleSearch(); 
                    fetchData(1); 
                } 
            };
        }

        window.onload = () => {
            const mode = localStorage.getItem('naixx_auth_mode');
            if(mode) unlockSite(mode);
        }
    </script>
</body>
</html>
